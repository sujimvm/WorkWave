<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.Team2Project.WorkWave.model.ComBoardMapper">
  		<!-- 공고리스트 -->
    	<select id="getComBoardList" parameterType="HashMap" resultType="bDTO">
    		<![CDATA[
	  		select * 
	  		from (select row_number() over(order by com_board_date desc) rnum, b.* 
	  		from com_board b where com_board_start_date <= sysdate and com_board_end_date >= sysdate)Pb join company c on c.company_key = Pb.company_key
	  		where rnum >= #{pdto.startNo} and rnum <= #{pdto.endNo}
	  		]]>
	  	</select>
	  	<!-- 관심기업리스트 -->
    	<select id="getInterestCompanyKeyList" resultType="int" parameterType="int">
	  		select company_key from interest where user_key = #{user_key}
	  	</select>
	  	<select id="countComBoard" resultType="int">
		  	<![CDATA[
		  		select COUNT(*) 
		  		from (select row_number() over(order by com_board_date desc) rnum, b.* 
		  		from com_board b where com_board_start_date <= sysdate and com_board_end_date >= sysdate)Pb join company c on c.company_key = Pb.company_key
	  		]]>
	    </select>
	  	<!-- 공고 지원리스트 -->
    	<select id="getApplyList" resultType="int" parameterType="int">
	  		select com_board_key from apply 
	  		where profile_key in (select profile_key from profile where user_key = #{user_key} and profile_default = 'Y')
	  	</select>
	  	
	  	
  		<!-- 업무코드 대분류 -->
	  	<select id="getJobCodeGroupList" resultType="codeDTO">
	  		select * from jobdata where length(code) = 2 order by code
	  	</select>
  		<!-- 업무코드 중분류 -->
	  	<select id="getJobCodeSubList" resultType="codeDTO">
	  		select * from jobdata where length(code) = 5 order by code
	  	</select>
  		<!-- 업무코드 소분류 -->
	  	<select id="getJobCodeStepList" resultType="codeDTO">
	  		select * from jobdata where length(code) = 7 order by code
	  	</select>
	  	
	  	
  		<!-- 지역코드 대분류 -->
	  	<select id="getLocationCodeGroupList" resultType="codeDTO">
	  		select * from locationdata where length(code) = 2 order by code
	  	</select>
  		<!-- 지역코드 중분류 -->
	  	<select id="getLocationCodeSubList" resultType="codeDTO">
	  		select * from locationdata where length(code) = 5 order by code
	  	</select>
	  	
	  	
  		<!-- 공고등록 -->
	  	<insert id="addComBoard" parameterType="bDTO">
	  		insert into com_board values(key_seq.nextval, #{company_key}, #{com_board_title}, #{com_board_start_date,jdbcType=DATE},
	  		#{com_board_end_date,jdbcType=DATE}, #{com_board_group}, #{com_board_sub}, #{com_board_step}, #{com_board_jobtype},
	  		#{com_board_mojib}, #{com_board_week}, #{com_board_time}, #{com_board_career}, #{com_board_edu}, #{com_board_sal},
	  		#{com_board_conditions}, #{com_board_benefits}, #{com_board_mgr_name}, #{com_board_mgr_phone}, #{com_board_mgr_email},
	  		#{com_board_cont}, sysdate)
	  	</insert>
	  	
	  	
	  	<!-- 임시테이블 공고삭제 -->
	  	<delete id="deleteComBoardTemp" parameterType="int">
	  		delete from com_board_temp where com_board_key = #{temp_key}
	  	</delete>
  		<!-- 공고등록 임시저장 -->
	  	<insert id="addComBoardTemp" parameterType="bDTO">
	  		insert into com_board_temp values(key_seq.nextval, #{company_key}, #{com_board_title}, #{com_board_start_date,jdbcType=DATE},
	  		#{com_board_end_date,jdbcType=DATE}, #{com_board_group}, #{com_board_sub}, #{com_board_step}, #{com_board_jobtype},
	  		#{com_board_mojib}, #{com_board_week}, #{com_board_time}, #{com_board_career}, #{com_board_edu}, #{com_board_sal},
	  		#{com_board_conditions}, #{com_board_benefits}, #{com_board_mgr_name}, #{com_board_mgr_phone}, #{com_board_mgr_email},
	  		#{com_board_cont}, sysdate)
	  	</insert>
	  	<!-- 공고등록 임시저장 기본키 조회 -->
	  	<select id="selectTempPk" parameterType="int" resultType="int">
	  		select max(com_board_key) from com_board_temp where company_key = #{company_key}
	  	</select>
	  	
	  	
	  	<!-- 관심기업 등록/해제 -->
	  	<insert id="insertInterestCheck" parameterType="iDTO">
	  		insert into interest values(key_seq.nextval, #{company_key}, #{user_key}, sysdate)
	  	</insert>
	  	<delete id="deleteInterestCheck" parameterType="bDTO">
	  		delete from interest where company_key = #{company_key} and user_key = #{user_key}
	  	</delete>
	  	
	  	
	  	<!-- 기업지원 -->
	  	<select id="selectDefaultProfile" resultType="int" parameterType="int">
	  		select profile_key from profile where user_key = #{user_key} and profile_default = 'Y'
	  	</select>
	  	<insert id="addApply" parameterType="aDTO">
	  		insert into apply values(key_seq.nextval, #{profile_key}, #{com_board_key}, sysdate, default)
	  	</insert>
	  	
	  	
	  	<!-- 공고상세보기 -->
	  	<select id="getComBoard" parameterType="int" resultType="bDTO">
	  		select * from com_board b join company c on c.company_key = b.company_key where b.com_board_key = #{com_board_key}
	  	</select>
	  	<select id="getApplyCount" parameterType="int" resultType="int">
	  		select count(*) from apply where com_board_key = #{com_board_key}
	  	</select>
	  	<select id="getApplyAvgAge" parameterType="int" resultType="map">
  		    select floor((months_between(sysdate, user_birth) / 12) / 5) * 5 as age, count(*) as count
			from (select user_birth, row_number() over (partition by u.user_key order by p.profile_key) as rnum
			from users u left join profile p on u.user_key = p.user_key
			where p.profile_key in ( select profile_key from apply where apply.com_board_key = #{com_board_key}))
			where rnum = 1 group by floor((months_between(sysdate, user_birth) / 12) / 5) * 5 order by age
	  	</select>
	  	<select id="getApplyAvgGender" parameterType="int" resultType="map">
  		    select user_gender as gender, count(*) as count
			from (select user_gender, row_number() over (partition by u.user_key order by p.profile_key) as rnum
			from users u left join profile p on u.user_key = p.user_key
			where p.profile_key in (select profile_key from apply where apply.com_board_key = #{com_board_key})) 
			where rnum = 1 group by user_gender order by gender
	  	</select>
	  	<select id="getApplyAvgEdu" parameterType="int" resultType="map">
		  	select edu_kind as edu, count(*) as count
			from (select e.edu_kind, row_number() over (partition by p.user_key order by p.profile_key) as rnum
			from edu e join profile p on e.profile_key = p.profile_key 
			where p.profile_key in (select profile_key from apply where com_board_key = 25 ))
			where rnum = 1 group by edu_kind order by edu_kind
	  	</select>
	  	
	  	<!-- 공고 수정 -->
	  	<update id="updateComBoard" parameterType="bDTO">
	    	update com_board 
	    	set com_board_title = #{com_board_title}, com_board_start_date = #{com_board_start_date,jdbcType=DATE},
	  		com_board_end_date = #{com_board_end_date,jdbcType=DATE}, com_board_group = #{com_board_group}, 
	  		com_board_sub = #{com_board_sub}, com_board_step = #{com_board_step}, com_board_jobtype = #{com_board_jobtype},
	  		com_board_mojib = #{com_board_mojib}, com_board_week = #{com_board_week}, com_board_time = #{com_board_time}, 
	  		com_board_career = #{com_board_career}, com_board_edu = #{com_board_edu}, com_board_sal = #{com_board_sal},
	  		com_board_conditions = #{com_board_conditions}, com_board_benefits = #{com_board_benefits}, com_board_mgr_name = #{com_board_mgr_name}, 
	  		com_board_mgr_phone = #{com_board_mgr_phone}, com_board_mgr_email = #{com_board_mgr_email}, com_board_cont = #{com_board_cont}
	    	where com_board_key = #{com_board_key}
	    </update>
	    
	    <!-- 메인에 출력할 공고 -->
	    <select id="getMainNewComBoardList" resultType="bDTO">
	    	<![CDATA[
		  		select * 
		  		from (select row_number() over(order by com_board_date desc) rnum, b.* 
		  		from com_board b  where com_board_start_date <= sysdate and com_board_end_date >= sysdate)Pb 
		  		join company c on c.company_key = Pb.company_key
		  		where rnum >= 1 and rnum <= 10
	            order by com_board_date desc
	  		]]>
	  	</select>
	    <select id="getMainHotComBoardList" resultType="bDTO"> <!-- 쿼리수정 -->
		    <![CDATA[
		  		select * 
		  		from (select row_number() over(order by com_board_date desc) rnum, b.* 
		  		from com_board b  where com_board_start_date <= sysdate and com_board_end_date >= sysdate)Pb 
		  		join company c on c.company_key = Pb.company_key
		  		where rnum >= 1 and rnum <= 10
	            order by com_board_date
	  		]]>
	  	</select>
	    <select id="getMainTimeComBoardList" resultType="bDTO"> <!-- 쿼리수정 -->
		    <![CDATA[
		  		select * 
		  		from (select row_number() over(order by com_board_date) rnum, b.* 
		  		from com_board b  where com_board_start_date <= sysdate and com_board_end_date >= sysdate)Pb 
		  		join company c on c.company_key = Pb.company_key
		  		where rnum >= 1 and rnum <= 9
	            order by com_board_date desc
	  		]]>
	  	</select>
  </mapper>
