<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시물 상세 내역 페이지</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
	
    <!-- 부트스트랩 CSS 추가 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
    	.my-chat-style{
    		text-align: right;
    		cursor: pointer;
    		margin-right: 5px;
    	}
    </style>
</head>
<body>
<div th:replace="~{include/header}"></div>
    <div class="container">
        <div class="text-center mt-5">
            <hr class="w-25 border-danger">
            <h3 th:text="${cont.user_id} + ' 님 게시물 상세 내역 페이지'"></h3>
            <hr class="w-25 border-danger">
            <br><br>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div th:if="${not #strings.isEmpty(cont)}">
                            <table class="table table-bordered">
                           		<tr>
                                    <th colspan="2"><h5 id="like-btn" class="my-chat-style">🧡</h5></th>
                                </tr>
                                <tr>
                                    <th>게시글 번호</th>
                                    <td th:text="${cont.chat_key}"></td>
                                </tr>
                                <tr>
                                    <th>게시글 작성자</th>
                                    <td th:text="${cont.user_id}"></td>
                                </tr>
                                <tr>
                                    <th>게시글 제목</th>
                                    <td th:text="${cont.chat_title}"></td>
                                </tr>
                                <tr>
                                    <th>게시글 내용</th>
                                    <td>
                                        <textarea class="form-control" rows="7" readonly>[[${cont.chat_cont}]]</textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <th>게시글 조회수</th>
                                    <td th:text="${cont.chat_hit}"></td>
                                </tr>
                                
                                <tr>
                                    <th>태그</th>
                                    <td th:text="${cont.chat_tag}"></td>
                                </tr>
                                
                                 <tr>
                                    <th>좋아요 수</th>
                                    <td th:text="${cont.chat_like}" id="like"></td>
                                </tr>
                                
                                
                                <tr>
                                    <th>게시글 작성일자</th>
                                    <td th:if="${#strings.isEmpty(cont.chat_update)}" th:text="${cont.chat_date}"></td>
                                 </tr>
                                 <tr>
                                    <th>게시글 수정일자</th>
                                    <td th:if="${not #strings.isEmpty(cont.chat_update)}" th:text="${cont.chat_update}"></td>
                                </tr>
                            </table>
                        </div>

                        <div th:if="${#strings.isEmpty(cont)}" class="text-center">
                            <h3>게시물에 대한 상세 정보가 없습니다.</h3>
                        </div>

                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-primary" th:onclick="|location.href='@{/U/chat/update(no=${cont.chat_key})}'|">글수정</button>
                            <button type="button" class="btn btn-danger" th:onclick="|if(confirm('정말로 게시글을 삭제하시겠습니까?')){ location.href='@{/U/chat/delete(no=${cont.chat_key})}' }else{return;}|">글삭제</button>
                            <button type="button" class="btn btn-secondary" th:onclick="|location.href='@{/A/chat}'|">전체목록</button>
                        </div>
                        <div class="container mt-5">
						  <h1>댓글</h1>
						  <hr>
						  <!-- 댓글 입력 폼 -->
						  <div>
						    <div class="form-group">
						      <label for="replycont">댓글 내용</label>
						      <textarea class="form-control" id="replycont" rows="3" placeholder="댓글을 입력하세요"></textarea>
						    </div>
						    <button type="button" class="btn btn-primary" id="replybtn">댓글 남기기</button>
						  </div>
						  <hr>
						  <!-- 댓글 목록 -->
						  <div id="replyList">
						    <!-- 여기에 댓글이 동적으로 추가될 예정 -->
						    <!-- 예제 댓글 박스 -->
						    <div class="card mb-3" id="reply-box">
						      <div class="card-body" th:if="${not #lists.isEmpty(list)}" th:each="dto : ${list}">
						        <h5 class="card-title" th:text="${dto.user_name}"></h5>
						        <h6 class="card-subtitle mb-2 text-muted" th:text="${dto.reply_date}"></h6>
						        <p class="card-text" th:text="${dto.reply_content}"></p>
						        <div class="d-flex justify-content-end">         
				                  <h5 class="my-chat-style">🧡 <span th:id="'replylike' + ${dto.reply_key}" th:text="${dto.reply_like}"></span></h5>
				                </div>
						      </div>
						    </div>
						  </div>
						</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 부트스트랩 JS 및 jQuery 추가 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script th:inline="javascript">
		let chat_key = /*[[${cont.chat_key}]]*/ null;
		let like_count = 0;
		let replylike_count = 0;
		
		$(document).ready(function () {
			let baseUrl = window.location.origin;
			console.log(baseUrl);
			console.log(chat_key);
			
			function ajaxGo(formData, url_in) {
				$.ajax({
					type : 'post',
					url : baseUrl + url_in,
					processData: false, // FormData 객체를 사용하기 때문에 false로 설정
		            contentType: false, // FormData 객체를 사용하기 때문에 false로 설정
					data : formData,
					success : function(map) {
						alert(map.message);
						if(map.type == 'like'){
							/* location.reload(); */
							$('#like').text(parseInt($('#like').text() ) + 1);	
						}else if(map.type == 'reply'){
							let reply_cont = map.reply_cont;
							let reply_date = map.reply_date;
							let user_name = map.user_name;
							
							let $reply_box = $('#reply-box');
							
							$reply_box.prepend(
								`
								<div class="card-body">
							        <h5 class="card-title" >${user_name}</h5>
							        <h6 class="card-subtitle mb-2 text-muted" >${reply_date}</h6>
							        <p class="card-text">${reply_cont}</p>
						      	</div>
								`
							);
						}else if(map.type == 'replylike'){
							$('#replylike').text(parseInt($('#replylike').text()) + 1);
						}
							
					},
					error : function() {
						alert('데이터 통신 오류')
					}
				});
			}
			
			$('#like-btn').click(function () {
				if(like_count > 0){
					alert("할당량 초과");
				}else{
					let formData = new FormData();
					formData.append("chat_key",chat_key);
					ajaxGo(formData, '/ajax/chatLike')
					like_count = like_count + 1;
				}
			});
			

			$('#replybtn').click(function () {
				let reply_cont = $('#replycont').val();	
				alert(reply_cont);
				let formData = new FormData();
				formData.append("reply_cont", reply_cont);
				formData.append("chat_key",chat_key);
				ajaxGo(formData, '/ajax/reply')	
				
			});
			
			$('#replylike').click(function () {
				if(replylike_count > 0){
					alert("할당량 초과");
				}else{
					let formData = new FormData();
					formData.append("reply_key",reply_key);
					ajaxGo(formData, '/ajax/replyLike')
					replylike_count = replylike_count + 1;
				}
			});
		});
		
	</script>
	
	<div th:replace="~{include/footer :: footer}"></div>
</body>
</html>
