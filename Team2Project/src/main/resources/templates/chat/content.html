<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시물 상세 내역 페이지</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/include.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">

</head>
<body>
<div th:replace="~{include/header}"></div>
<div layout:fragment="content" class="content">
    <div class="mainContainer">
        <div class="sidebar active">
            <h3><a th:href="@{/U/chat/insert}">질문 · 글쓰기</a></h3>
            <br>
            <table class="chat-user">
                <tr>
                    <th>내 정보</th>
                </tr>
                <tr>
                    <th class="chat-table">
                        <th:block th:if="${null != session.uDTO}">
                            <span th:text="${session.uDTO.user_name}"></span> <br>
                            <span th:text="${session.uDTO.user_id}"></span> <br>
                            <span th:inline="text">질문 [[${chatCnt}]]개</span>
                        </th:block>
                        <th:block th:if="${null == session.uDTO}">
                            <span>게스트</span>
                        </th:block>
                    </th>
                </tr>
            </table>
        </div>
        <div class="chat-info">
            <div class="content">
                <h3 th:inline="text">🍳 [[${cont.chat_title}]]</h3>
                <ul class="chat-list">
                    <li th:inline="text" style="padding-bottom: 40px;"> [[${cont.chat_cont}]]</li>
                    <li th:inline="text"> 😀 [[${cont.user_id}]]</li>
                    <li th:inline="text" style="align-content: center">
                        👀 [[${cont.chat_hit}]]
                        <button id="like-btn" class="like-btn">🧡</button> <span id="like">[[${cont.chat_like}]]</span>
                    </li>
                    <br>
                    <li>
                        <th:block th:if="${null != session.uDTO}">
                            <div class="reply-div" id="reply-box">
                                <form id="replyForm" method="post">
                                    <textarea id="replyCont" name="reply_cont" rows="3" cols="100" placeholder="솔직하고 따뜻한 댓글을 남겨주세요~"></textarea>
                                    <input id="replyBtn" class="reply-btn" type="submit" value="댓글 작성">
                                </form>
                            </div>
                        </th:block>
                        <th:block th:if="${null == session.uDTO}">
                            <a th:href="@{/login}">
                                <textarea name="reply_cont" rows="2" cols="100" placeholder="로그인 후 댓글을 남겨주세요~"></textarea>
                            </a>
                        </th:block>
                    </li>
                </ul>
                <br>
                <div id="reply-box"></div>
                <br>
                <div align="right">
                    <button class="goList" onclick="window.history.back()">목록 보기</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{include/footer :: footer}"></div>

<script th:inline="javascript">
    let chat_key = /*[[${cont.chat_key}]]*/ null;
    let like_count = 0;
    let replylike_count = 0;
    
    $(document).ready(function () {
        let baseUrl = window.location.origin;
        console.log(baseUrl);
        console.log(chat_key);
        
        function ajaxGo(formData, url_in) {
            $.ajax({
                type: 'post',
                url: baseUrl + url_in,
                processData: false, // FormData 객체를 사용하기 때문에 false로 설정
                contentType: false, // FormData 객체를 사용하기 때문에 false로 설정
                data: formData,
                success: function(map) {
                    console.log('AJAX 성공:', map);
                    alert(map.message);
                    if (map.type === 'like') {
                        $('#like').text(parseInt($('#like').text()) + 1);    
                    } else if (map.type === 'reply') {
                        let reply_cont = map.reply_cont;
                        let reply_date = map.reply_date;
                        let user_name = map.user_name;
                        
                        let $reply_box = $('#reply-box');
       
                        $reply_box.prepend(
                        	    `
                        	    <div class="reply-div">
                        	        <div class="reply-meta">
                        	            <span class="username">${user_name}</span>
                        	            <span class="reply-date">${reply_date}</span>
                        	        </div>
                        	        <p class="reply-content">${reply_cont}</p>
                        	    </div>
                        	    `
                        	);
                    } else if (map.type === 'replylike') {
                        $('#replylike').text(parseInt($('#replylike').text()) + 1);
                    }
                },
                error: function() {
                    console.log('AJAX 오류');
                    alert('데이터 통신 오류');
                }
            });
        }
        
        $('#like-btn').click(function () {
            console.log('좋아요 버튼 클릭됨');
            if (like_count > 0) {
                alert("좋아요 버튼은 한번만 누를수 있습니다");
            } else {
                let formData = new FormData();
                formData.append("chat_key", chat_key);
                ajaxGo(formData, '/ajax/chatLike');
                like_count += 1;
            }
        });
        
        $('#replyBtn').click(function (event) {
            event.preventDefault(); // 폼 제출 기본 동작 방지
            let reply_cont = $('#replyCont').val();
            let formData = new FormData();
            formData.append("reply_cont", reply_cont);
            formData.append("chat_key", chat_key);
            ajaxGo(formData, '/ajax/reply');
        });
    });
</script>
</body>
</html>
