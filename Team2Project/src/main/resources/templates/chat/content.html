<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ì—­ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
	
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS ì¶”ê°€ -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
    	.my-chat-style{
    		text-align: right;
    		cursor: pointer;
    		margin-right: 5px;
    	}
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mt-5">
            <hr class="w-25 border-danger">
            <h3 th:text="${cont.user_id} + ' ë‹˜ ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ì—­ í˜ì´ì§€'"></h3>
            <hr class="w-25 border-danger">
            <br><br>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div th:if="${not #strings.isEmpty(cont)}">
                            <table class="table table-bordered">
                           		<tr>
                                    <th colspan="2"><h5 id="like-btn" class="my-chat-style">ğŸ§¡</h5></th>
                                </tr>
                                <tr>
                                    <th>ê²Œì‹œê¸€ ë²ˆí˜¸</th>
                                    <td th:text="${cont.chat_key}"></td>
                                </tr>
                                <tr>
                                    <th>ê²Œì‹œê¸€ ì‘ì„±ì</th>
                                    <td th:text="${cont.user_id}"></td>
                                </tr>
                                <tr>
                                    <th>ê²Œì‹œê¸€ ì œëª©</th>
                                    <td th:text="${cont.chat_title}"></td>
                                </tr>
                                <tr>
                                    <th>ê²Œì‹œê¸€ ë‚´ìš©</th>
                                    <td>
                                        <textarea class="form-control" rows="7" readonly>[[${cont.chat_cont}]]</textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <th>ê²Œì‹œê¸€ ì¡°íšŒìˆ˜</th>
                                    <td th:text="${cont.chat_hit}"></td>
                                </tr>
                                
                                <tr>
                                    <th>íƒœê·¸</th>
                                    <td th:text="${cont.chat_tag}"></td>
                                </tr>
                                
                                 <tr>
                                    <th>ì¢‹ì•„ìš” ìˆ˜</th>
                                    <td th:text="${cont.chat_like}" id="like"></td>
                                </tr>
                                
                                
                                <tr>
                                    <th>ê²Œì‹œê¸€ ì‘ì„±ì¼ì</th>
                                    <td th:if="${#strings.isEmpty(cont.chat_update)}" th:text="${cont.chat_date}"></td>
                                 </tr>
                                 <tr>
                                    <th>ê²Œì‹œê¸€ ìˆ˜ì •ì¼ì</th>
                                    <td th:if="${not #strings.isEmpty(cont.chat_update)}" th:text="${cont.chat_update}"></td>
                                </tr>
                            </table>
                        </div>

                        <div th:if="${#strings.isEmpty(cont)}" class="text-center">
                            <h3>ê²Œì‹œë¬¼ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>
                        </div>

                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-primary" th:onclick="|location.href='@{/U/chat/update(no=${cont.chat_key})}'|">ê¸€ìˆ˜ì •</button>
                            <button type="button" class="btn btn-danger" th:onclick="|if(confirm('ì •ë§ë¡œ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ location.href='@{/U/chat/delete(no=${cont.chat_key})}' }else{return;}|">ê¸€ì‚­ì œ</button>
                            <button type="button" class="btn btn-secondary" th:onclick="|location.href='@{/chat}'|">ì „ì²´ëª©ë¡</button>
                        </div>
                        <div class="container mt-5">
						  <h1>ëŒ“ê¸€</h1>
						  <hr>
						  <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
						  <div>
						    <div class="form-group">
						      <label for="replycont">ëŒ“ê¸€ ë‚´ìš©</label>
						      <textarea class="form-control" id="replycont" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
						    </div>
						    <button type="button" class="btn btn-primary" id="replybtn">ëŒ“ê¸€ ë‚¨ê¸°ê¸°</button>
						  </div>
						  <hr>
						  <!-- ëŒ“ê¸€ ëª©ë¡ -->
						  <div id="replyList">
						    <!-- ì—¬ê¸°ì— ëŒ“ê¸€ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì˜ˆì • -->
						    <!-- ì˜ˆì œ ëŒ“ê¸€ ë°•ìŠ¤ -->
						    <div class="card mb-3" id="reply-box">
						      <div class="card-body" th:if="${not #lists.isEmpty(list)}" th:each="dto : ${list}">
						        <h5 class="card-title" th:text="${dto.user_name}"></h5>
						        <h6 class="card-subtitle mb-2 text-muted" th:text="${dto.reply_date}"></h6>
						        <p class="card-text" th:text="${dto.reply_content}"></p>
						        <div class="d-flex justify-content-end">         
				                  <h5 class="my-chat-style">ğŸ§¡ <span th:id="'replylike' + ${dto.reply_key}" th:text="${dto.reply_like}"></span></h5>
				                </div>
						      </div>
						    </div>
						  </div>
						</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© JS ë° jQuery ì¶”ê°€ -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script th:inline="javascript">
		let chat_key = /*[[${cont.chat_key}]]*/ null;
		let like_count = 0;
		let replylike_count = 0;
		
		$(document).ready(function () {
			let baseUrl = window.location.origin;
			console.log(baseUrl);
			console.log(chat_key);
			
			function ajaxGo(formData, url_in) {
				$.ajax({
					type : 'post',
					url : baseUrl + url_in,
					processData: false, // FormData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— falseë¡œ ì„¤ì •
		            contentType: false, // FormData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— falseë¡œ ì„¤ì •
					data : formData,
					success : function(map) {
						alert(map.message);
						if(map.type == 'like'){
							/* location.reload(); */
							$('#like').text(parseInt($('#like').text() ) + 1);	
						}else if(map.type == 'reply'){
							let reply_cont = map.reply_cont;
							let reply_date = map.reply_date;
							let user_name = map.user_name;
							
							let $reply_box = $('#reply-box');
							
							$reply_box.prepend(
								`
								<div class="card-body">
							        <h5 class="card-title" >${user_name}</h5>
							        <h6 class="card-subtitle mb-2 text-muted" >${reply_date}</h6>
							        <p class="card-text">${reply_cont}</p>
						      	</div>
								`
							);
						}else if(map.type == 'replylike'){
							$('#replylike').text(parseInt($('#replylike').text()) + 1);
						}
							
					},
					error : function() {
						alert('ë°ì´í„° í†µì‹  ì˜¤ë¥˜')
					}
				});
			}
			
			$('#like-btn').click(function () {
				if(like_count > 0){
					alert("í• ë‹¹ëŸ‰ ì´ˆê³¼");
				}else{
					let formData = new FormData();
					formData.append("chat_key",chat_key);
					ajaxGo(formData, '/ajax/chatLike')
					like_count = like_count + 1;
				}
			});
			

			$('#replybtn').click(function () {
				let reply_cont = $('#replycont').val();	
				alert(reply_cont);
				let formData = new FormData();
				formData.append("reply_cont", reply_cont);
				formData.append("chat_key",chat_key);
				ajaxGo(formData, '/ajax/reply')	
				
			});
			
			$('#replylike').click(function () {
				if(replylike_count > 0){
					alert("í• ë‹¹ëŸ‰ ì´ˆê³¼");
				}else{
					let formData = new FormData();
					formData.append("reply_key",reply_key);
					ajaxGo(formData, '/ajax/replyLike')
					replylike_count = replylike_count + 1;
				}
			});
		});
		
	</script>
	

</body>
</html>
