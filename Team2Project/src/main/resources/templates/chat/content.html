<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ì—­ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/include.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">

</head>
<body>
	<div th:replace="~{include/header}"></div>
	<div layout:fragment="content" class="content">
        <div class="sidebar active">
            <h3><a th:href="@{/U/chat/insert}">ì§ˆë¬¸ Â· ê¸€ì“°ê¸°</a></h3>
            <br>
            <table class="chat-user">
                <tr>
                    <th>ë‚´ ì •ë³´</th>
                </tr>
                <tr>
                    <th class="chat-table">
                        <th:block th:if="${null != session.uDTO}">
                            <!-- <span th:text="${session.uDTO.user_name}"></span> <br> -->
                            <span class="user_id" th:text="${session.uDTO.user_id}"></span> <br>
                            <span style="display: none;" class="user_key" th:text="${session.uDTO.user_key}"></span> <br>
                            <span th:inline="text">ë‚´ê°€ ì‘ì„±í•œ ê¸€ [[${chatCnt}]] ê°œ</span>
                        </th:block>
                        <th:block th:if="${null == session.uDTO}">
                            <span>ê²ŒìŠ¤íŠ¸</span>
                        </th:block>
                    </th>
                </tr>
            </table>
        </div>
        
        <div class="chat-info sidebar_r">
			<h3 th:inline="text">ğŸ³ [[${cont.chat_title}]]</h3>
			<ul class="chat-list">
			    <li><div  th:utext="${cont.chat_cont}"></div></li>
			    <li style="border-bottom: 1px solid #ddd;" th:inline="text"> ğŸ˜€ [[${cont.user_id}]]</li>
			    <li style="border-bottom: 1px solid #ddd;" th:inline="text"> [[${cont.chat_tag}]]</li>
			    <li th:inline="text" style="align-content: center">
			        ğŸ‘€ [[${cont.chat_hit}]]
			        <button id="like-btn" class="like-btn">ğŸ§¡</button> <span id="like">[[${cont.chat_like}]]</span>
			    </li>
			  
			    <br>
			    
			    <div>
				    <a th:href="@{/U/chat/update(no=${cont.chat_key})}">
    					<input type="button" value="ê¸€ìˆ˜ì •" class="btn-custom">
					</a>
					<a href="javascript:void(0);" th:onclick="|if(confirm('ê¸€ì‚­ì œ?')){
								location.href='@{/U/chat/delete(no=${cont.chat_key})}'
								}else{return;}|">
   						 <input type="button" value="ê¸€ì‚­ì œ" class="btn-custom">
					</a>
				</div>
			    <li>
			        <th:block th:if="${null != session.uDTO}">
			            <div class="reply-div" id="reply-box">
			                <form id="replyForm" method="post">
			                    <textarea id="replyCont" name="reply_cont" rows="3" cols="120" placeholder="ì†”ì§í•˜ê³  ë”°ëœ»í•œ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”~"></textarea>
			                    <input id="replyBtn" class="reply-btn" type="submit" value="ëŒ“ê¸€ ì‘ì„±">
			                </form>
			            </div>
			        </th:block>
			        <th:block th:if="${null == session.uDTO}">
			            <a th:href="@{/login}">
			                <textarea name="reply_cont" rows="2" cols="100" placeholder="ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”~"></textarea>
			            </a>
			        </th:block>
			    </li>
			    
			</ul>	
			<br>
			<div id="reply_box">
				<div class="reply_body" th:if="${not #lists.isEmpty(list)}" th:each="dto : ${list}">
            	        <span class="user-id"  th:text="${dto.user_id}"></span>
            	        <br>
            	        <span class="reply-date" th:text="${#dates.format(dto.reply_date, 'yyyy/MM/dd')} + ' ì‘ì„±'"></span>
            	        <p class="reply-content" th:text="${dto.reply_content}"></p>
            	      
            	  <button class=btn-edit th:if="${dto.user_id == session.uDTO.user_id}" th:attr="data-reply-key=${dto.reply_key}" onclick="editReply(this)">ìˆ˜ì •</button>
	        	  <button class=btn-delete th:attr="data-reply-key=${dto.reply_key}" onclick="deleteReply(this)">ì‚­ì œ</button>
	        	  <br> <br>
	        	  

	           	<div th:id="'edit-form-'+${dto.reply_key}" class="d-none" style="display:none;">
				             <textarea rows="2" th:id="'edit-reply-'+${dto.reply_key}"></textarea> <br>
				             <label for="replyedit" >ëŒ“ê¸€ ìˆ˜ì •</label> <br>
				             <button class=btn-edit th:attr="data-reply-key=${dto.reply_key}" onclick="saveReply(this)">ì €ì¥</button>
				             <button class=btn-delete th:onclick="'cancelEdit(' + ${dto.reply_key} + ')'" >ì·¨ì†Œ</button>
				</div>
	        </div>
	        </div>
	        <hr>
	        
	        
		
			<div align="right">
			    <button class="goList" onclick="window.history.back()">ëª©ë¡ ë³´ê¸°</button>
		    </div>
		</div>
	</div>
	<div th:replace="~{include/footer :: footer}"></div>
	
	<script th:inline="javascript">
	    let chat_key = /*[[${cont.chat_key}]]*/ null;
	    console.log('chat_key:', chat_key); // chat_key ê°’ í™•ì¸
	    let like_count = 0;
	  
	    
	    

	    function cancelEdit(replyKey) {
	        $('#edit-form-' + replyKey).addClass('d-none');
	    }	
	   
        
        function editReply(button) {
	        var replyKey = $(button).data('reply-key');
	        $('#edit-form-' + replyKey).removeClass('d-none');
	        $('#edit-form-' + replyKey).show();
	        // ê¸°ì¡´ ëŒ“ê¸€ ë‚´ìš©ì„ ìˆ˜ì • í¼ì— ë„£ê¸°
	        var currentContent = $('button[data-reply-key="' + replyKey + '"]').closest('.reply_body').find('.reply-content').text();
	        $('#edit-reply-' + replyKey).val(currentContent);
	    }
        
        function saveReply(button) {
            var replyKey = $(button).data('reply-key');
            var replyContent = $('#edit-reply-' + replyKey).val();
            
            var formData = new FormData();
            formData.append("reply_key", replyKey);
            formData.append("reply_content", replyContent);
            
            $.ajax({
                type: 'post',
                url: '/ajax/editReply',
                processData: false,
                contentType: false,
                data: formData,
                success: function(response) {
                    alert(response.message);
                    // ëŒ“ê¸€ ë‚´ìš© ì—…ë°ì´íŠ¸
                    $('button[data-reply-key="' + replyKey + '"]').closest('.reply_body').find('.reply-content').text(replyContent);
                    cancelEdit(replyKey);
                },
                error: function() {
                    alert('ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
	    
	    
	    
	    function deleteReply(button) {
		    if (confirm('ì •ë§ë¡œ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {  // ì¶”ê°€ëœ í™•ì¸ ëŒ€í™” ìƒì
		        var replyKey = $(button).data('reply-key');
		        var formData = new FormData();
		        formData.append("reply_key", replyKey);
		        
		        $.ajax({
		            type: 'post',
		            url: '/ajax/deleteReply',
		            processData: false,
		            contentType: false,
		            data: formData,
		            success: function(response) {
		                $(button).closest('.reply_body').remove();
		                alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
		            },
		            error: function() {
		                alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
		            }
		        });
		    }
		}
	    
	    
	    
	    $(document).ready(function () {
	        let baseUrl = window.location.origin;
	        console.log('chat_key:', chat_key); // chat_key ê°’ í™•ì¸
	        console.log(baseUrl);
	        console.log(chat_key);
	        
	        function ajaxGo(formData, url_in) {
	            $.ajax({
	                type: 'post',
	                url: baseUrl + url_in,
	                processData: false, // FormData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— falseë¡œ ì„¤ì •
	                contentType: false, // FormData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— falseë¡œ ì„¤ì •
	                data: formData,
	                success: function(map) {
	                    console.log('AJAX ì„±ê³µ:', map);
	                    alert(map.message);
	                    if (map.type === 'like') {
	                        $('#like').text(parseInt($('#like').text()) + 1);    
	                    } else if (map.type === 'reply') {
	                        let reply_cont = map.reply_cont;
	                        let reply_date = map.reply_date;
	                        let user_name = map.user_name;
	                        
	                        let $reply_box = $('#reply-box');
	       
	                        $reply_box.prepend(
	                        	    `
	                        	    <div class="reply_body">
                        	            <span class="user-id">${map.user_id}</span>
                        	            <span class="reply-date">${map.reply_date}</span>
                        	        	<p class="reply-content">${map.reply_cont}</p>
	                        	    </div>
	                        	    `
	                        	);
	                    } else if (map.type === 'replylike') {
	                        $('#replylike').text(parseInt($('#replylike').text()) + 1);
	                    }
	                },
	                error: function() {
	                    console.log('AJAX ì˜¤ë¥˜');
	                    alert('ë°ì´í„° í†µì‹  ì˜¤ë¥˜');
	                }
	            });
	        }
	        
	        $('#like-btn').click(function () {
	            console.log('ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ë¨');
	            if (like_count > 0) {
	                alert("ì¢‹ì•„ìš” ë²„íŠ¼ì€ í•œë²ˆë§Œ ëˆ„ë¥¼ìˆ˜ ìˆìŠµë‹ˆë‹¤");
	            } else {
	                let formData = new FormData();
	                formData.append("chat_key", chat_key);
	                ajaxGo(formData, '/ajax/chatLike');
	                like_count += 1;
	            }
	        });
	        
	        $('#replyBtn').click(function (event) {
	            event.preventDefault(); // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€
	            let reply_cont = $('#replyCont').val();
	            let formData = new FormData();
	            formData.append("reply_cont", reply_cont);
	            formData.append("chat_key", chat_key);
	            // user_key
	            formData.append("user_key", $(".user_key").text());
	            formData.append("user_id", $(".user_id").text());
	            ajaxGo(formData, '/ajax/reply');
	        });
	    });
	</script>
</body>
</html>
