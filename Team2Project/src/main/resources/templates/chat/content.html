<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œë¬¼ ìƒì„¸ ë‚´ì—­ í˜ì´ì§€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/include.css}">
    <link rel="stylesheet" th:href="@{/css/chat.css}">

</head>
<body>
	<div th:replace="~{include/header}"></div>
	<div layout:fragment="content" class="content">
        <div class="sidebar active">
            <h3><a th:href="@{/U/chat/insert}">ì§ˆë¬¸ Â· ê¸€ì“°ê¸°</a></h3>
            <br>
            <table class="chat-user">
                <tr>
                    <th>ë‚´ ì •ë³´</th>
                </tr>
                <tr>
                    <th class="chat-table">
                        <th:block th:if="${null != session.uDTO}">
                            <span th:text="${session.uDTO.user_name}"></span> <br>
                            <span class="user_id" th:text="${session.uDTO.user_id}"></span> <br>
                            <span style="display: none;" class="user_key" th:text="${session.uDTO.user_key}"></span> <br>
                            <span th:inline="text">ì§ˆë¬¸ [[${chatCnt}]]ê°œ</span>
                        </th:block>
                        <th:block th:if="${null == session.uDTO}">
                            <span>ê²ŒìŠ¤íŠ¸</span>
                        </th:block>
                    </th>
                </tr>
            </table>
        </div>
        
        <div class="chat-info sidebar_r">
			<h3 th:inline="text">ğŸ³ [[${cont.chat_title}]]</h3>
			<ul class="chat-list">
			    <li th:inline="text" style="padding-bottom: 40px;"> [[${cont.chat_cont}]]</li>
			    <li th:inline="text"> ğŸ˜€ [[${cont.user_id}]]</li>
			    <li th:inline="text"> [[${cont.chat_tag}]]</li>
			    <li th:inline="text" style="align-content: center">
			        ğŸ‘€ [[${cont.chat_hit}]]
			        <button id="like-btn" class="like-btn">ğŸ§¡</button> <span id="like">[[${cont.chat_like}]]</span>
			    </li>
			    
			    <br>
			    
			    <div>
				    <a th:href="@{/U/chat/update(no=${cont.chat_key})}">
    					<input type="button" value="ê¸€ìˆ˜ì •" class="btn-custom">
					</a>
					<a href="javascript:void(0);" th:onclick="|if(confirm('ê¸€ì‚­ì œ?')){
								location.href='@{/U/chat/delete(no=${cont.chat_key})}'
								}else{return;}|">
   						 <input type="button" value="ê¸€ì‚­ì œ" class="btn-custom">
					</a>
				</div>
			    <li>
			        <th:block th:if="${null != session.uDTO}">
			            <div class="reply-div" id="reply-box">
			                <form id="replyForm" method="post">
			                    <textarea id="replyCont" name="reply_cont" rows="3" cols="120" placeholder="ì†”ì§í•˜ê³  ë”°ëœ»í•œ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”~"></textarea>
			                    <input id="replyBtn" class="reply-btn" type="submit" value="ëŒ“ê¸€ ì‘ì„±">
			                </form>
			            </div>
			        </th:block>
			        <th:block th:if="${null == session.uDTO}">
			            <a th:href="@{/login}">
			                <textarea name="reply_cont" rows="2" cols="100" placeholder="ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”~"></textarea>
			            </a>
			        </th:block>
			    </li>
			</ul>
			<br>
			<div id="reply-box"></div>
			<br>
			<div align="right">
			    <button class="goList" onclick="window.history.back()">ëª©ë¡ ë³´ê¸°</button>
		    </div>
		</div>
	</div>
	<div th:replace="~{include/footer :: footer}"></div>
	
	<script th:inline="javascript">
	    let chat_key = /*[[${cont.chat_key}]]*/ null;
	    let like_count = 0;
	    let replylike_count = 0;
	    
	    $(document).ready(function () {
	        let baseUrl = window.location.origin;
	        console.log(baseUrl);
	        console.log(chat_key);
	        
	        function ajaxGo(formData, url_in) {
	            $.ajax({
	                type: 'post',
	                url: baseUrl + url_in,
	                processData: false, // FormData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— falseë¡œ ì„¤ì •
	                contentType: false, // FormData ê°ì²´ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— falseë¡œ ì„¤ì •
	                data: formData,
	                success: function(map) {
	                    console.log('AJAX ì„±ê³µ:', map);
	                    alert(map.message);
	                    if (map.type === 'like') {
	                        $('#like').text(parseInt($('#like').text()) + 1);    
	                    } else if (map.type === 'reply') {
	                        let reply_cont = map.reply_cont;
	                        let reply_date = map.reply_date;
	                        let user_name = map.user_name;
	                        
	                        let $reply_box = $('#reply-box');
	       
	                        $reply_box.prepend(
	                        	    `
	                        	    <div class="reply-div">
	                        	        <div class="reply-meta">
	                        	            <span class="username">${user_name}</span>
	                        	            <span class="reply-date">${reply_date}</span>
	                        	        </div>
	                        	        <p class="reply-content">${reply_cont}</p>
	                        	    </div>
	                        	    `
	                        	);
	                    } else if (map.type === 'replylike') {
	                        $('#replylike').text(parseInt($('#replylike').text()) + 1);
	                    }
	                },
	                error: function() {
	                    console.log('AJAX ì˜¤ë¥˜');
	                    alert('ë°ì´í„° í†µì‹  ì˜¤ë¥˜');
	                }
	            });
	        }
	        
	        $('#like-btn').click(function () {
	            console.log('ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ë¨');
	            if (like_count > 0) {
	                alert("ì¢‹ì•„ìš” ë²„íŠ¼ì€ í•œë²ˆë§Œ ëˆ„ë¥¼ìˆ˜ ìˆìŠµë‹ˆë‹¤");
	            } else {
	                let formData = new FormData();
	                formData.append("chat_key", chat_key);
	                ajaxGo(formData, '/ajax/chatLike');
	                like_count += 1;
	            }
	        });
	        
	        $('#replyBtn').click(function (event) {
	            event.preventDefault(); // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€
	            let reply_cont = $('#replyCont').val();
	            let formData = new FormData();
	            formData.append("reply_cont", reply_cont);
	            formData.append("chat_key", chat_key);
	            // user_key
	            formData.append("user_key", $(".user_key").text());
	            formData.append("user_id", $(".user_id").text());
	            ajaxGo(formData, '/ajax/reply');
	        });
	    });
	</script>
</body>
</html>
