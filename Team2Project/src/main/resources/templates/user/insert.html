<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <style>
        .checkmark {
            display: none;
            color: green;
            font-size: 16px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <h2>회원가입</h2>
    <form action="#" th:action="@{/insertUser}" th:object="${user}" method="post">
        <table>
            <tr>
                <td><label for="user_id">아이디:</label></td>
                <td>
                    <input type="text" id="user_id" th:field="*{user_id}" required>
                    <button type="button" id="checkIdBtn">중복 확인</button>
                    <span id="checkmark" class="checkmark">✔</span>
                </td>
            </tr>
            <tr>
                <td><label for="user_pwd">비밀번호:</label></td>
                <td>
                    <input type="password" id="user_pwd" th:field="*{user_pwd}" required>
                    <span id="pwdCheckmark" class="checkmark">✔</span>
                    <span id="pwdError" style="display:none; color: red; font-size: 12px;">비밀번호는 8자 이상 20자 이하이며 특수문자 1자를 포함해야 합니다.</span>
                </td>
            </tr>
            <tr>
                <td><label for="user_name">이름:</label></td>
                <td><input type="text" id="user_name" th:field="*{user_name}" required></td>
            </tr>
            <tr>
                <td><label for="user_email">이메일:</label></td>
                <td>
                    <input type="text" id="user_email" th:field="*{user_email}" required>
                    <button type="button" id="sendCode">인증번호 발송</button>
                </td>
            </tr>
            <tr id="veriCodeContainer" style="display: none;">
                <td><label for="veri_code">인증번호:</label></td>
                <td>
                    <input type="text" id="veri_code">
                    <button type="button" id="verifyCode">인증번호 확인</button>
                    <span id="veriCheckmark" class="checkmark">✔</span>
                </td>
            </tr>
            <tr>
                <td><label for="user_phone">전화번호:</label></td>
                <td><input type="text" id="user_phone" th:field="*{user_phone}" required></td>
            </tr>
            <tr>
                <td><label for="user_addr">주소:</label></td>
                <td><input type="text" id="user_addr" th:field="*{user_addr}" required></td>
            </tr>
            <tr>
                <td><label for="user_birth">생년월일:</label></td>
                <td><input type="date" id="user_birth" th:field="*{user_birth}" required></td>
            </tr>
            <tr>
                <td><label for="user_gender">성별:</label></td>
                <td>
                    <select id="user_gender" th:field="*{user_gender}">
                        <option value="M">남성</option>
                        <option value="F">여성</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center;">
                    <button type="submit">회원가입</button>
                </td>
            </tr>
        </table>
    </form>
</body>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    $('#sendCode').click(function() {
        var email = $('#user_email').val();
        console.log("Sending verification code to: " + email);
        $.ajax({
            url: '/sendCode',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({ email: email }),
            success: function(response) {
                console.log("Response: ", response);
                if (response.status === "success") {
                    alert("인증번호가 이메일로 전송되었습니다.");
                    $('#veriCodeContainer').show();
                } else {
                    alert("인증번호 전송에 실패했습니다.");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error: ", textStatus, errorThrown);
                alert("인증번호 전송에 실패했습니다.");
            }
        });
    });

    $('#verifyCode').click(function() {
        var email = $('#user_email').val();
        var code = $('#veri_code').val();
        console.log("Verifying code for: " + email);
        $.ajax({
            url: '/verifyCode',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({ email: email, code: code }),
            success: function(response) {
                console.log("Response: ", response);
                if (response.status === "success") {
                    $('#veriCheckmark').show();
                    alert(response.message);
                } else {
                    $('#veriCheckmark').hide();
                    alert(response.message);
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error: ", textStatus, errorThrown);
                alert("인증번호 확인에 실패했습니다.");
            }
        });
    });

    $('#checkIdBtn').click(function() {
        var userId = $('#user_id').val();
        console.log("Checking ID for: " + userId);
        $.ajax({
            url: '/checkUserId',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({ userId: userId }),
            success: function(response) {
                console.log("Response: ", response);
                if (response.status === "available") {
                    $('#checkmark').show();
                    alert("사용 가능한 아이디입니다.");
                } else {
                    $('#checkmark').hide();
                    alert("이미 사용 중인 아이디입니다.");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error: ", textStatus, errorThrown);
                alert("아이디 확인에 실패했습니다.");
            }
        });
    });

    $('#user_pwd').on('input', function() {
        var pwd = $(this).val();
        var pwdPattern = /^(?=.*[!@#$%^&*(),.?":{}|<>])[A-Za-z\d!@#$%^&*(),.?":{}|<>]{8,20}$/;
        if (pwdPattern.test(pwd)) {
            $('#pwdCheckmark').show();
            $('#pwdError').hide();
        } else {
            $('#pwdCheckmark').hide();
            $('#pwdError').show();
        }
    });
});
</script>
</html>
